<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Two Pointers: Two Different Arrays | Algorithm Visualizer</title>
    <style>
        :root {
            --bg: transparent;
            --card: #ffffff;
            --text: #1a1a1a;
            --muted: #737373;
            --border: #e5e5e5;

            /* Array-specific colors */
            --accent-arr1: #3b82f6;
            --accent-arr1-bg: #eff6ff;
            --accent-arr2: #f59e0b;
            --accent-arr2-bg: #fef3c7;
            --accent-merged: #22c55e;
            --accent-merged-bg: #f0fdf4;

            /* Pointer colors */
            --pointer-i: #3b82f6;
            --pointer-j: #f59e0b;
            --pointer-k: #22c55e;

            /* State colors */
            --comparing: #a78bfa;
            --comparing-bg: #f5f3ff;
            --copying: #22c55e;
            --copying-bg: #f0fdf4;
            --success: #22c55e;
            --success-bg: #f0fdf4;
            --error: #ef4444;
            --error-bg: #fef2f2;

            --radius: 8px;
            --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            --sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--sans);
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 32px 20px 48px;
        }

        /* Header */
        header {
            margin-bottom: 32px;
        }

        h1 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: -0.01em;
            color: var(--accent-arr1-bg);
        }

        .subtitle {
            color: var(--muted);
            font-size: 14px;
        }

        /* Card */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 16px;
        }

        /* Controls */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: flex-end;
        }

        .input-group {
            flex: 1;
            min-width: 200px;
        }

        .input-group label {
            display: block;
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 6px;
        }

        .input-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            font-family: var(--mono);
            transition: border-color 0.15s;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--accent-arr1);
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 18px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--card);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.15s, border-color 0.15s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        button:hover:not(:disabled) {
            background: var(--bg);
            border-color: var(--muted);
        }

        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        button.primary {
            background: var(--accent-arr1);
            border-color: var(--accent-arr1);
            color: white;
        }

        button.primary:hover:not(:disabled) {
            background: #2563eb;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
        }

        .speed-control label {
            font-size: 13px;
            color: var(--muted);
        }

        .speed-control input[type="range"] {
            flex: 1;
            max-width: 200px;
        }

        .speed-control .speed-value {
            font-family: var(--mono);
            font-size: 12px;
            color: var(--muted);
            min-width: 70px;
        }

        /* Visualization */
        .viz-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
        }

        .array-section {
            width: 100%;
            margin-bottom: 24px;
        }

        .array-label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            text-align: center;
        }

        .array-label.arr1 { color: var(--accent-arr1); }
        .array-label.arr2 { color: var(--accent-arr2); }
        .array-label.merged { color: var(--accent-merged); }

        .array-viz {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            min-height: 60px;
        }

        .cell {
            position: relative;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-family: var(--mono);
            font-size: 16px;
            font-weight: 600;
            transition: border-color 0.2s, background-color 0.2s, opacity 0.2s, transform 0.2s;
        }

        .cell.active-i {
            border-color: var(--accent-arr1);
            background: var(--accent-arr1-bg);
        }

        .cell.active-j {
            border-color: var(--accent-arr2);
            background: var(--accent-arr2-bg);
        }

        .cell.active-k {
            border-color: var(--accent-merged);
            background: var(--accent-merged-bg);
        }

        .cell.comparing {
            border-color: var(--comparing);
            background: var(--comparing-bg);
        }

        .cell.copying {
            border-color: var(--copying);
            background: var(--copying-bg);
            animation: pulse 0.3s ease-in-out;
        }

        .cell.completed {
            background: var(--success-bg);
            opacity: 0.7;
        }

        .cell.exhausted {
            opacity: 0.3;
        }

        .cell.placeholder {
            opacity: 0.2;
            border-style: dashed;
        }

        .empty-cell {
            color: var(--muted);
            font-size: 13px;
            padding: 12px;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .pointer {
            position: absolute;
            bottom: -26px;
            font-size: 11px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.2s;
            color: white;
        }

        .pointer.i {
            background: var(--pointer-i);
        }

        .pointer.j {
            background: var(--pointer-j);
        }

        .pointer.k {
            background: var(--pointer-k);
        }

        .cell.show-i .pointer.i,
        .cell.show-j .pointer.j,
        .cell.show-k .pointer.k {
            opacity: 1;
        }

        /* Status */
        .status-bar {
            width: 100%;
            margin-top: 20px;
            padding: 14px 16px;
            border-radius: var(--radius);
            font-size: 14px;
            text-align: center;
            background: var(--bg);
            color: var(--muted);
            transition: background-color 0.2s, color 0.2s;
        }

        .status-bar.success {
            background: var(--success-bg);
            color: var(--success);
        }

        .status-bar.error {
            background: var(--error-bg);
            color: var(--error);
        }

        .status-bar.info {
            background: var(--accent-arr1-bg);
            color: var(--accent-arr1);
        }

        /* Educational Panels */
        .panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 640px) {
            .panels {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .panel-header {
            padding: 14px 20px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .panel-body {
            padding: 20px;
        }

        /* Pseudocode */
        .pseudocode {
            font-family: var(--mono);
            font-size: 13px;
            line-height: 1.9;
        }

        .code-line {
            padding: 4px 10px;
            border-radius: 4px;
            transition: background-color 0.15s;
            white-space: pre;
            border-left: 2px solid transparent;
        }

        .code-line.highlight {
            background: var(--accent-merged-bg);
            border-left-color: var(--accent-merged);
        }

        .code-line .keyword {
            color: #7c3aed;
        }

        .code-line .comment {
            color: var(--muted);
        }

        /* Explanation */
        .explanation {
            min-height: 140px;
        }

        .explanation .step-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text);
            font-size: 15px;
        }

        .explanation .step-detail {
            color: var(--muted);
            font-size: 14px;
            line-height: 1.7;
        }

        .explanation .calculation {
            margin-top: 16px;
            padding: 14px;
            background: var(--bg);
            border-radius: var(--radius);
            font-family: var(--mono);
            font-size: 14px;
        }

        .explanation .calculation .highlight-arr1 {
            color: var(--accent-arr1);
            font-weight: 600;
        }

        .explanation .calculation .highlight-arr2 {
            color: var(--accent-arr2);
            font-weight: 600;
        }

        .explanation .calculation .highlight-merged {
            color: var(--accent-merged);
            font-weight: 600;
        }

        .explanation .reason {
            margin-top: 14px;
            padding: 12px 14px;
            background: var(--accent-arr1-bg);
            border-radius: var(--radius);
            font-size: 13px;
            color: var(--accent-arr1);
        }

        .explanation .reason.arr2 {
            background: var(--accent-arr2-bg);
            color: #b45309;
        }

        .explanation .reason.found {
            background: var(--success-bg);
            color: var(--success);
        }

        /* Iteration counter */
        .iteration-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 13px;
            font-weight: 500;
            color: var(--muted);
            margin-bottom: 24px;
        }

        .iteration-badge .count {
            font-family: var(--mono);
            font-weight: 600;
            color: var(--text);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 32px;
            color: var(--muted);
        }

        .empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Two Pointers: Two Different Arrays</h1>
            <p class="subtitle">Merge two sorted arrays into one sorted array</p>
        </header>

        <!-- Controls -->
        <div class="card">
            <div class="card-title">Configuration</div>
            <div class="controls">
                <div class="input-group">
                    <label for="array1Input">Sorted Array 1 (comma-separated)</label>
                    <input type="text" id="array1Input" value="1, 3, 5, 7" placeholder="1, 3, 5">
                </div>
                <div class="input-group">
                    <label for="array2Input">Sorted Array 2 (comma-separated)</label>
                    <input type="text" id="array2Input" value="2, 4, 6, 8" placeholder="2, 4, 6">
                </div>
                <div class="btn-group">
                    <button id="btnLoad" class="primary">Load</button>
                    <button id="btnRandom">Random</button>
                </div>
            </div>
            <div style="margin-top: 16px; border-top: 1px solid var(--border); padding-top: 16px;">
                <div class="btn-group">
                    <button id="btnStep" disabled>Step</button>
                    <button id="btnPlay" disabled>Play</button>
                    <button id="btnReset" disabled>Reset</button>
                </div>
                <div class="speed-control">
                    <label>Speed:</label>
                    <input type="range" id="speedSlider" min="100" max="1500" value="600" step="100">
                    <span class="speed-value" id="speedValue">600ms</span>
                </div>
            </div>
        </div>

        <!-- Visualization -->
        <div class="card">
            <div class="viz-container">
                <div class="iteration-badge">
                    Iteration: <span class="count" id="iterCount">0</span> |
                    Merged: <span class="count" id="mergedLength">0</span>
                </div>

                <!-- Array 1 -->
                <div class="array-section">
                    <div class="array-label arr1">Array 1</div>
                    <div class="array-viz" id="array1Viz">
                        <div class="empty-state">
                            <p>Enter arrays and click Load to begin</p>
                        </div>
                    </div>
                </div>

                <!-- Array 2 -->
                <div class="array-section">
                    <div class="array-label arr2">Array 2</div>
                    <div class="array-viz" id="array2Viz">
                        <div class="empty-state">
                            <p>Enter arrays and click Load to begin</p>
                        </div>
                    </div>
                </div>

                <!-- Merged Result -->
                <div class="array-section">
                    <div class="array-label merged">Merged Result</div>
                    <div class="array-viz" id="mergedViz">
                        <div class="empty-state">
                            <p>Empty - waiting for merge</p>
                        </div>
                    </div>
                </div>

                <div class="status-bar" id="statusBar">
                    Ready to start. Enter two sorted arrays.
                </div>
            </div>
        </div>

        <!-- Educational Panels -->
        <div class="panels">
            <!-- Pseudocode -->
            <div class="panel">
                <div class="panel-header">Algorithm</div>
                <div class="panel-body">
                    <div class="pseudocode" id="pseudocode">
                        <div class="code-line" data-line="0"><span class="keyword">def</span> merge(arr1, arr2):</div>
                        <div class="code-line" data-line="1">  i, j = 0, 0</div>
                        <div class="code-line" data-line="2">  merged = []</div>
                        <div class="code-line" data-line="3">  <span class="keyword">while</span> i < len(arr1) <span class="keyword">and</span> j < len(arr2):</div>
                        <div class="code-line" data-line="4">    <span class="keyword">if</span> arr1[i] <= arr2[j]:</div>
                        <div class="code-line" data-line="5">      merged.append(arr1[i])</div>
                        <div class="code-line" data-line="6">      i += 1</div>
                        <div class="code-line" data-line="7">    <span class="keyword">else</span>:</div>
                        <div class="code-line" data-line="8">      merged.append(arr2[j])</div>
                        <div class="code-line" data-line="9">      j += 1</div>
                        <div class="code-line" data-line="10">  <span class="keyword">while</span> i < len(arr1):</div>
                        <div class="code-line" data-line="11">    merged.append(arr1[i])</div>
                        <div class="code-line" data-line="12">    i += 1</div>
                        <div class="code-line" data-line="13">  <span class="keyword">while</span> j < len(arr2):</div>
                        <div class="code-line" data-line="14">    merged.append(arr2[j])</div>
                        <div class="code-line" data-line="15">    j += 1</div>
                        <div class="code-line" data-line="16">  <span class="keyword">return</span> merged</div>
                    </div>
                </div>
            </div>

            <!-- Explanation -->
            <div class="panel">
                <div class="panel-header">What's Happening</div>
                <div class="panel-body">
                    <div class="explanation" id="explanation">
                        <div class="step-title">Ready to Start</div>
                        <div class="step-detail">
                            This algorithm merges two sorted arrays into one sorted array.
                            It uses two pointers, one for each array, to compare elements.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== State =====
        const state = {
            arr1: [],
            arr2: [],
            merged: [],
            i: 0,
            j: 0,
            k: 0,
            iteration: 0,
            done: false,
            phase: 'mainLoop',
            subStep: 'compare',
            playing: false,
            timer: null,
            runId: 0,
            pendingTimers: [],
            currentLine: -1,
            lastComparison: null,
            lastCopy: null
        };

        // ===== DOM Elements =====
        const $ = id => document.getElementById(id);
        const array1Input = $('array1Input');
        const array2Input = $('array2Input');
        const array1Viz = $('array1Viz');
        const array2Viz = $('array2Viz');
        const mergedViz = $('mergedViz');
        const iterCount = $('iterCount');
        const mergedLength = $('mergedLength');
        const statusBar = $('statusBar');
        const pseudocode = $('pseudocode');
        const explanation = $('explanation');
        const btnLoad = $('btnLoad');
        const btnRandom = $('btnRandom');
        const btnStep = $('btnStep');
        const btnPlay = $('btnPlay');
        const btnReset = $('btnReset');
        const speedSlider = $('speedSlider');
        const speedValue = $('speedValue');

        // ===== Utilities =====
        function parseArray(text) {
            const parts = text.split(',').map(s => s.trim()).filter(Boolean);
            if (parts.length === 0) return [];
            const nums = parts.map(p => Number(p));
            if (nums.some(n => isNaN(n))) {
                throw new Error('Array contains non-numeric values');
            }
            return nums;
        }

        function generateRandomArrayPair() {
            const len1 = Math.floor(Math.random() * 5) + 3;
            const len2 = Math.floor(Math.random() * 5) + 3;

            const arr1 = Array.from({ length: len1 }, () =>
                Math.floor(Math.random() * 20) + 1
            ).sort((a, b) => a - b);

            const arr2 = Array.from({ length: len2 }, () =>
                Math.floor(Math.random() * 20) + 1
            ).sort((a, b) => a - b);

            return { arr1, arr2 };
        }

        // ===== Rendering =====
        function renderSingleArray(arr, containerId, activeIndex, pointerLabel, arrayType) {
            const container = $(containerId);

            if (arr.length === 0) {
                container.innerHTML = '<div class="empty-cell">Empty</div>';
                return;
            }

            container.innerHTML = arr.map((value, index) => {
                const classes = ['cell'];

                if (index === activeIndex && activeIndex < arr.length) {
                    classes.push(`active-${pointerLabel}`, `show-${pointerLabel}`);
                }

                if (index < activeIndex) {
                    classes.push('exhausted');
                }

                if (state.subStep === 'compare' && index === activeIndex && state.phase === 'mainLoop') {
                    classes.push('comparing');
                }

                if (state.subStep === 'copy' && index === activeIndex &&
                    state.lastComparison?.chosen === arrayType && state.phase === 'mainLoop') {
                    classes.push('copying');
                }

                return `
                    <div class="${classes.join(' ')}">
                        ${value}
                        <span class="pointer ${pointerLabel}">${pointerLabel.toUpperCase()}</span>
                    </div>
                `;
            }).join('');
        }

        function renderMergedArray() {
            const container = mergedViz;

            if (state.merged.length === 0) {
                container.innerHTML = '<div class="empty-cell">Empty - waiting for merge</div>';
                return;
            }

            const totalExpected = state.arr1.length + state.arr2.length;
            const cells = [];

            for (let idx = 0; idx < state.merged.length; idx++) {
                const classes = ['cell', 'completed'];

                if (idx === state.merged.length - 1 && state.lastCopy) {
                    classes.push('copying');
                }

                cells.push(`
                    <div class="${classes.join(' ')}">
                        ${state.merged[idx]}
                    </div>
                `);
            }

            if (!state.done && state.merged.length < totalExpected) {
                cells.push(`
                    <div class="cell active-k show-k">
                        ?
                        <span class="pointer k">K</span>
                    </div>
                `);
            }

            for (let idx = state.merged.length + 1; idx < totalExpected; idx++) {
                cells.push(`<div class="cell placeholder">?</div>`);
            }

            container.innerHTML = cells.join('');
        }

        function renderArrays() {
            renderSingleArray(state.arr1, 'array1Viz', state.i, 'i', 'arr1');
            renderSingleArray(state.arr2, 'array2Viz', state.j, 'j', 'arr2');
            renderMergedArray();
        }

        function renderPseudocode(line) {
            const lines = pseudocode.querySelectorAll('.code-line');
            lines.forEach(el => {
                el.classList.remove('highlight');
                if (parseInt(el.dataset.line) === line) {
                    el.classList.add('highlight');
                }
            });
        }

        function renderExplanation(type, data = {}) {
            const templates = {
                init: () => `
                    <div class="step-title">Initialized</div>
                    <div class="step-detail">
                        Two pointers (i, j) start at the beginning of each array.
                        Pointer k tracks where to write in the merged result.
                    </div>
                    <div class="calculation">
                        i = 0 (arr1), j = 0 (arr2), k = 0 (merged)
                        <br>
                        arr1: ${state.arr1.length} elements
                        <br>
                        arr2: ${state.arr2.length} elements
                        <br>
                        Expected merged: ${state.arr1.length + state.arr2.length} elements
                    </div>
                `,

                compare: () => {
                    const val1 = state.arr1[state.i];
                    const val2 = state.arr2[state.j];
                    const chosen = state.lastComparison.chosen;

                    return `
                        <div class="step-title">Comparing Values</div>
                        <div class="step-detail">
                            Compare current elements from both arrays to find the smaller one.
                        </div>
                        <div class="calculation">
                            arr1[<span class="highlight-arr1">i=${state.i}</span>] = <span class="highlight-arr1">${val1}</span>
                            <br>
                            arr2[<span class="highlight-arr2">j=${state.j}</span>] = <span class="highlight-arr2">${val2}</span>
                            <br>
                            ${val1 <= val2 ? `${val1} ≤ ${val2}` : `${val2} < ${val1}`}
                        </div>
                        <div class="reason ${chosen === 'arr2' ? 'arr2' : ''}">
                            Choose ${chosen === 'arr1' ? `arr1[${state.i}] = ${val1}` : `arr2[${state.j}] = ${val2}`}
                            as it's smaller${val1 === val2 ? ' (or equal)' : ''}.
                        </div>
                    `;
                },

                copy: (chosen) => {
                    const copy = state.lastCopy;
                    return `
                        <div class="step-title">Copy to Merged</div>
                        <div class="step-detail">
                            Copy the smaller value to the merged array and advance pointers.
                        </div>
                        <div class="calculation">
                            merged[<span class="highlight-merged">k=${copy.toIndex}</span>] = ${copy.value}
                            <br>
                            ${chosen === 'arr1' ? `i: ${state.i - 1} → ${state.i}` : `j: ${state.j - 1} → ${state.j}`}
                            <br>
                            k: ${state.k - 1} → ${state.k}
                        </div>
                        <div class="reason found">
                            Merged array now has ${state.merged.length} element(s).
                        </div>
                    `;
                },

                cleanupArr1: () => `
                    <div class="step-title">Copy Remaining from Array 1</div>
                    <div class="step-detail">
                        Array 2 is exhausted. Copy all remaining elements from Array 1.
                    </div>
                    <div class="calculation">
                        Copying arr1[${state.i - 1}] = ${state.lastCopy.value}
                        <br>
                        Remaining in arr1: ${state.arr1.length - state.i} elements
                    </div>
                `,

                cleanupArr2: () => `
                    <div class="step-title">Copy Remaining from Array 2</div>
                    <div class="step-detail">
                        Array 1 is exhausted. Copy all remaining elements from Array 2.
                    </div>
                    <div class="calculation">
                        Copying arr2[${state.j - 1}] = ${state.lastCopy.value}
                        <br>
                        Remaining in arr2: ${state.arr2.length - state.j} elements
                    </div>
                `,

                complete: () => `
                    <div class="step-title">Merge Complete!</div>
                    <div class="step-detail">
                        All elements from both arrays have been merged in sorted order.
                    </div>
                    <div class="calculation">
                        Original arrays: ${state.arr1.length} + ${state.arr2.length} = ${state.arr1.length + state.arr2.length}
                        <br>
                        Merged result: ${state.merged.length} elements
                        <br>
                        Merged: [${state.merged.join(', ')}]
                    </div>
                    <div class="reason found">
                        Algorithm completed in O(n + m) time with O(n + m) space!
                    </div>
                `,

                ready: () => `
                    <div class="step-title">Ready to Start</div>
                    <div class="step-detail">
                        This algorithm merges two sorted arrays into one sorted array.
                        It uses two pointers, one for each array, to compare elements.
                    </div>
                `
            };

            explanation.innerHTML = templates[type] ? templates[type](data) : templates.ready();
        }

        function setStatus(message, type = '') {
            statusBar.textContent = message;
            statusBar.className = 'status-bar' + (type ? ` ${type}` : '');
        }

        function updateButtons() {
            const canRun = (state.arr1.length > 0 || state.arr2.length > 0) && !state.done;
            btnStep.disabled = !canRun || state.playing;
            btnPlay.disabled = !canRun;
            btnReset.disabled = state.arr1.length === 0 && state.arr2.length === 0;
            btnPlay.textContent = state.playing ? 'Pause' : 'Play';
        }

        function renderAll() {
            renderArrays();
            iterCount.textContent = state.iteration;
            mergedLength.textContent = state.merged.length;
            updateButtons();
        }

        // ===== Algorithm =====
        function initRun() {
            stopPlaying();
            state.runId += 1;

            try {
                const arr1 = parseArray(array1Input.value);
                const arr2 = parseArray(array2Input.value);

                if (arr1.length === 0 && arr2.length === 0) {
                    throw new Error('At least one array must have elements');
                }

                const sortedArr1 = [...arr1].sort((a, b) => a - b);
                const sortedArr2 = [...arr2].sort((a, b) => a - b);

                let initialPhase = 'mainLoop';
                if (sortedArr1.length === 0) initialPhase = 'cleanup2';
                else if (sortedArr2.length === 0) initialPhase = 'cleanup1';

                Object.assign(state, {
                    arr1: sortedArr1,
                    arr2: sortedArr2,
                    merged: [],
                    i: 0,
                    j: 0,
                    k: 0,
                    iteration: 0,
                    done: false,
                    phase: initialPhase,
                    subStep: 'compare',
                    playing: false,
                    currentLine: 1,
                    lastComparison: null,
                    lastCopy: null
                });

                setStatus(`Loaded: ${sortedArr1.length} + ${sortedArr2.length} elements. Click Step or Play.`, 'info');
                renderExplanation('init');
                renderPseudocode(1);
                renderAll();

            } catch (e) {
                setStatus(e.message, 'error');
                Object.assign(state, {
                    arr1: [],
                    arr2: [],
                    merged: [],
                    i: 0,
                    j: 0,
                    k: 0,
                    iteration: 0,
                    done: true
                });
                renderAll();
            }
        }

        function step() {
            if (state.done) return;

            // Phase 1: Main merge loop
            if (state.phase === 'mainLoop') {
                if (state.i >= state.arr1.length || state.j >= state.arr2.length) {
                    if (state.i < state.arr1.length) {
                        state.phase = 'cleanup1';
                    } else if (state.j < state.arr2.length) {
                        state.phase = 'cleanup2';
                    } else {
                        state.phase = 'complete';
                        state.done = true;
                        renderComplete();
                        return;
                    }
                    renderAll();
                    return;
                }

                if (state.subStep === 'compare') {
                    const val1 = state.arr1[state.i];
                    const val2 = state.arr2[state.j];

                    state.lastComparison = {
                        arr1Val: val1,
                        arr2Val: val2,
                        chosen: val1 <= val2 ? 'arr1' : 'arr2'
                    };

                    state.iteration++;
                    renderPseudocode(4);
                    renderExplanation('compare');
                    setStatus(`Comparing: arr1[${state.i}]=${val1} vs arr2[${state.j}]=${val2}`, 'info');

                    state.subStep = 'copy';
                    renderAll();
                    return;
                }

                if (state.subStep === 'copy') {
                    const chosen = state.lastComparison.chosen;

                    if (chosen === 'arr1') {
                        const val = state.arr1[state.i];
                        state.merged.push(val);
                        state.lastCopy = { value: val, from: 'arr1', toIndex: state.k };
                        state.i++;
                        renderPseudocode(5);
                    } else {
                        const val = state.arr2[state.j];
                        state.merged.push(val);
                        state.lastCopy = { value: val, from: 'arr2', toIndex: state.k };
                        state.j++;
                        renderPseudocode(8);
                    }

                    state.k++;
                    renderExplanation('copy', chosen);
                    setStatus(`Copied ${state.lastCopy.value} to merged[${state.lastCopy.toIndex}]`, 'success');

                    state.subStep = 'compare';
                    renderAll();
                    return;
                }
            }

            // Phase 2: Cleanup arr1
            if (state.phase === 'cleanup1') {
                if (state.i >= state.arr1.length) {
                    state.phase = 'complete';
                    state.done = true;
                    renderComplete();
                    return;
                }

                const val = state.arr1[state.i];
                state.merged.push(val);
                state.lastCopy = { value: val, from: 'arr1', toIndex: state.k };
                state.i++;
                state.k++;

                renderPseudocode(11);
                renderExplanation('cleanupArr1');
                setStatus(`Copying remaining arr1[${state.i - 1}]=${val}`, 'info');
                renderAll();
                return;
            }

            // Phase 3: Cleanup arr2
            if (state.phase === 'cleanup2') {
                if (state.j >= state.arr2.length) {
                    state.phase = 'complete';
                    state.done = true;
                    renderComplete();
                    return;
                }

                const val = state.arr2[state.j];
                state.merged.push(val);
                state.lastCopy = { value: val, from: 'arr2', toIndex: state.k };
                state.j++;
                state.k++;

                renderPseudocode(14);
                renderExplanation('cleanupArr2');
                setStatus(`Copying remaining arr2[${state.j - 1}]=${val}`, 'info');
                renderAll();
                return;
            }
        }

        function renderComplete() {
            setStatus('Merge complete! All elements merged in sorted order.', 'success');
            renderExplanation('complete');
            renderPseudocode(16);
            renderAll();
            stopPlaying();
        }

        function play() {
            if (state.done || (state.arr1.length === 0 && state.arr2.length === 0)) return;

            if (state.playing) {
                stopPlaying();
                setStatus('Paused. Click Step or Play to continue.', 'info');
                return;
            }

            state.playing = true;
            updateButtons();
            setStatus('Playing...', 'info');

            const currentRunId = state.runId;
            const tick = () => {
                if (!state.playing || state.done || state.runId !== currentRunId) {
                    stopPlaying();
                    return;
                }
                step();
                if (state.playing && !state.done && state.runId === currentRunId) {
                    state.timer = setTimeout(tick, Number(speedSlider.value));
                }
            };

            state.timer = setTimeout(tick, Number(speedSlider.value));
        }

        function stopPlaying() {
            state.playing = false;
            if (state.timer) {
                clearTimeout(state.timer);
                state.timer = null;
            }
            updateButtons();
        }

        function reset() {
            stopPlaying();
            initRun();
        }

        function loadRandom() {
            const { arr1, arr2 } = generateRandomArrayPair();
            array1Input.value = arr1.join(', ');
            array2Input.value = arr2.join(', ');
            initRun();
        }

        // ===== Event Listeners =====
        btnLoad.addEventListener('click', initRun);
        btnRandom.addEventListener('click', loadRandom);
        btnStep.addEventListener('click', step);
        btnPlay.addEventListener('click', play);
        btnReset.addEventListener('click', reset);

        speedSlider.addEventListener('input', () => {
            speedValue.textContent = `${speedSlider.value}ms`;
        });

        array1Input.addEventListener('keypress', e => {
            if (e.key === 'Enter') initRun();
        });
        array2Input.addEventListener('keypress', e => {
            if (e.key === 'Enter') initRun();
        });

        // Initialize on load
        speedValue.textContent = `${speedSlider.value}ms`;
        initRun();
    </script>
</body>
</html>
